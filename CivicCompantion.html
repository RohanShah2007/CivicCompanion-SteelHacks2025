<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const adviceOutput = document.getElementById('advice-output');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        let lastSeverity = 'Unknown';
        let lastAdviceHTML = '';

        const severityColors = {
            'Critical': 'bg-red-500',
            'Urgent': 'bg-yellow-500',
            'Medium': 'bg-blue-500',
            'Low': 'bg-green-500',
            'Unknown': 'bg-gray-400'
        };

        //method to put user chat from the textbox into the chat
        const addMessageToChat = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 my-2 rounded-lg max-w-xs ${sender === 'user' ? 'bg-indigo-500 text-white self-end rounded-br-none' : 'bg-white text-gray-800 self-start rounded-bl-none shadow'}`;
            messageDiv.innerHTML = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        //creates the tab on the bottom of the chatbox for the chatbot's advice
        const showAdvice = (severity, expectedExperience, patientRightsInfo, insuranceInfo, necessaryPaperwork) => {
            lastSeverity = severity;
            const htmlContent = `
                <div class="p-6 bg-white rounded-3xl shadow-xl space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">AI Advice & Guidance</h3>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-gray-600">Severity:</span>
                        <span class="px-3 py-1 rounded-full text-white text-sm font-medium ${severityColors[severity]}">${severity}</span>
                    </div>
                    
                    <div>
                        <span class="font-semibold text-gray-600">What to expect:</span>
                        <p class="text-gray-600 mt-2">${expectedExperience}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-600">Patient Rights:</span>
                        <p class="text-gray-600 mt-2">${patientRightsInfo}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-600">Insurance & Payment:</span>
                        <p class="text-gray-600 mt-2">${insuranceInfo}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-600">Necessary Paperwork:</span>
                        <p class="text-gray-600 mt-2">${necessaryPaperwork}</p>
                    </div>
                </div>
            `;
            adviceOutput.innerHTML = htmlContent;
            lastAdviceHTML = htmlContent;
            document.getElementById('return-to-advice-btn').classList.remove('hidden');
        };
        
        const showMessageModal = (title, message) => {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0";
            modal.innerHTML = `
                <div class="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm transform scale-95 transition-transform duration-300">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button class="w-full bg-indigo-600 text-white py-2 px-4 rounded-xl hover:bg-indigo-700 transition duration-300" onclick="this.closest('.fixed').remove()">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.bg-white').classList.remove('scale-95');
            }, 10);
        };

//pulls information from the patient bill of rights to tell the user about their rights as a patient
        const patientRightsContent = `
Patients have the right to timely, non-discriminatory care.
You have the right to confidential communication and privacy.
You have the right to an explanation of your diagnosis and treatment.
You can refuse or withdraw consent for a treatment.
You can request your medical records.
You can provide feedback on your care experience.
`;

//pulls information from healthcare.gov for health insurance rights and protections
        const insuranceContent = `
Insurance plans must cover people with pre-existing conditions without charging more.
You have the right to free preventive care.
There are no lifetime or yearly dollar limits on essential health benefits.
You have the right to appeal a health plan decision.
The law protects your choice of doctors and shields you from employer retaliation.
You have access to more coverage options as a young adult.
`;

        //based on the criticality of the symptoms, the chatbot will direct the patient to different places to get care.
        const findNearbyHelp = () => {
            let query = '';
            switch (lastSeverity) {
                case 'Critical':
                case 'Urgent':
                    query = 'emergency room near me';
                    break;
                case 'Medium':
                    query = 'urgent care clinic near me';
                    break;
                case 'Low':
                    query = 'general clinic near me';
                    break;
                default:
                    showMessageModal('Cannot Find Locations', 'Please describe your symptoms first to get a severity rating.');
                    return;
            }
            //opens a new window directing the user to google maps to find hospitals, clinics, or urgent care near them
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
        };
        
        //if the patient asks the chatbot a question unrelated to their symptoms, the chatbot will tell the user.
        const returnToAdvice = () => {
            if (lastAdviceHTML) {
                adviceOutput.innerHTML = lastAdviceHTML;
            } else {
                showMessageModal('No Advice Found', 'Please describe your symptoms first to get advice from the AI.');
            }
        };

        //button on sidebar for first aid
        const showFirstAidGuide = () => {
            adviceOutput.innerHTML = `
                <div class="p-6 bg-white rounded-3xl shadow-xl space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">First Aid Guide</h3>
                    <p class="text-gray-600 mt-2">
                        For minor injuries, remember:
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>Cuts & Scrapes: Clean the area with soap and water, apply an antiseptic, and cover with a sterile bandage.</li>
                        <li>Burns: Cool the burn under cool running water for several minutes. Do not use ice. Cover with a clean, dry dressing.</li>
                        <li>Sprains: Use the R.I.C.E. method: Rest, Ice, Compression, and Elevation.</li>
                    </ul>
                </div>
            `;
        };
        
        //button on sidebar for medication safety
        const showMedicationSafety = () => {
            adviceOutput.innerHTML = `
                <div class="p-6 bg-white rounded-3xl shadow-xl space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">Medication Safety</h3>
                    <p class="text-gray-600 mt-2">
                        Always follow these rules for safe medication use:
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>Take medication exactly as prescribed by your doctor.</li>
                        <li>Do not share medications with others.</li>
                        <li>Check expiration dates and properly dispose of old medication.</li>
                        <li>Inform your doctor of any allergies or other medications you are taking.</li>
                    </ul>
                </div>
            `;
        };
        
        //button on sidebar for emergency contacts
        const showEmergencyContacts = () => {
            adviceOutput.innerHTML = `
                <div class="p-6 bg-white rounded-3xl shadow-xl space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">Emergency Contacts</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>Emergency Services (Police, Fire, Medical): 911</li>
                        <li>Poison Control: 1-800-222-1222</li>
                        <li>National Suicide Prevention Lifeline: 988</li>
                    </ul>
                </div>
            `;
        };
        
        //button on sidebar for mental health resources
        const showMentalHealthResources = () => {
            adviceOutput.innerHTML = `
                <div class="p-6 bg-white rounded-3xl shadow-xl space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">Mental Health Resources</h3>
                    <p class="text-gray-600 mt-2">
                        Mental health is a critical part of your overall well-being.
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li>Seek Professional Help: A therapist or counselor can provide support and strategies for managing mental health challenges.</li>
                        <li>Practice Self-Care: Activities like exercise, meditation, hobbies, and spending time in nature can improve your mood and reduce stress.</li>
                        <li>Connect with Others: Talking to trusted friends or family can make a significant difference.</li>
                        <li>Mental Health Crisis Line: If you or someone you know is in crisis, call or text 988 to connect with a trained counselor.</li>
                    </ul>
                </div>
            `;
        };

        //takes in user input from the chat
        sendButton.addEventListener('click', async () => {
            const userText = chatInput.value.trim();
            if (userText === '') {
                addMessageToChat("Please describe your symptoms so I can provide a severity rating and a plan of action.", 'bot');
                return;
            }

            //takes the users chat from the textbox and puts it into the chatbox
            addMessageToChat(userText, 'user');
            chatInput.value = '';

            //gives the patient advice based on severity level
            try {
                const apiResponse = await callGeminiApi(userText);
                if (apiResponse) {
                    const { severity, expectedExperience, patientRightsInfo, insuranceInfo, necessaryPaperwork } = apiResponse;
                    addMessageToChat(`Based on your symptoms, your situation is considered **${severity}**.`, 'bot');
                    showAdvice(severity, expectedExperience, patientRightsInfo, insuranceInfo, necessaryPaperwork);
                } else {
                    addMessageToChat("Sorry, I could not process that. Please try again.", 'bot');
                }
            } catch (error) {
                addMessageToChat("An error occurred. Please try again later.", 'bot');
                console.error("Full error:", error);
            }
        });

        //gets the gemini api
        const callGeminiApi = async (prompt, retries = 3) => {
            loadingIndicator.classList.remove('hidden');
            const apiKey = "AIzaSyArEpjPPoBdBk1X-tdQMcstDZWT-vEY0QM";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            //uses the gemini api to produce a severity level, and promts the LLM to tell the user about expected experience patient rights, insurance, and paperwork. This information is specific to the users situation and is seperate to the general information on the sidebar for these topics
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "severity": { "type": "STRING", "enum": ["Critical", "Urgent", "Medium", "Low", "Unknown"], "description": "The severity level of the issue." },
                            "expectedExperience": { "type": "STRING", "description": "A few concise sentences about what the patient can expect." },
                            "patientRightsInfo": { "type": "STRING", "description": "A few concise sentences about key patient rights." },
                            "insuranceInfo": { "type": "STRING", "description": "A few concise sentences about insurance and payment." },
                            "necessaryPaperwork": { "type": "STRING", "description": "A few concise sentences about necessary paperwork to bring." }
                        },
                        "required": ["severity", "expectedExperience", "patientRightsInfo", "insuranceInfo", "necessaryPaperwork"]
                    }
                },
                //an introduction prompt for gemini api to describe its task
                systemInstruction: {
                    parts: [{ text: `You are a helpful and cautious AI medical assistant. Based on the user's described symptoms, provide a severity level and a few concise sentences for the expected experience. For a **Critical** or **Urgent** situation, suggest going to a hospital emergency room. For a **Medium** severity issue, suggest an urgent care clinic. For a **Low** severity issue, suggest a general clinic or primary care physician. **Do not provide a diagnosis.** For patient rights and insurance information, use the following provided text and summarize it into a few concise sentences. Additionally, based on the information, provide a short, concise summary of the necessary paperwork to bring to an appointment.

Patient Rights Source:
${patientRightsContent}

Insurance Source:
${insuranceContent}

ALWAYS respond with a valid JSON object matching the provided schema. Do not include any text outside the JSON object.` }]
                }
            };
            

            //handles potential errors with the gemini api so application doesnt fail or crash
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (response.ok && result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    return JSON.parse(jsonString);
                } else if (retries > 0) {
                    console.warn(`API call failed, retrying... (Attempts left: ${retries})`);
                    await new Promise(res => setTimeout(res, 2000));
                    return callGeminiApi(prompt, retries - 1);
                } else {
                    throw new Error('API call failed after multiple retries.');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

//adds the buttons on the sidebar with the correct information
        window.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('find-nearby-help-btn').addEventListener('click', findNearbyHelp);
            document.getElementById('first-aid-guide-btn').addEventListener('click', showFirstAidGuide);
            document.getElementById('medication-safety-btn').addEventListener('click', showMedicationSafety);
            document.getElementById('emergency-contacts-btn').addEventListener('click', showEmergencyContacts);
            document.getElementById('return-to-advice-btn').addEventListener('click', returnToAdvice);
            document.getElementById('mental-health-btn').addEventListener('click', showMentalHealthResources);
        });
    </script>
</head>

<body class="flex flex-col h-full antialiased font-sans bg-gray-100 p-4 sm:p-8">
    <!-- Header Bar -->
    <header class="w-full flex flex-col items-center py-4 px-6 rounded-3xl shadow-2xl bg-slate-50 border-2 border-slate-200 mb-8">
        <div class="flex items-center justify-between w-full">
            <!-- Logo & Title -->
            <div class="flex items-center space-x-4">
                <svg width="40" height="40" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M32 60C16.5 60 4 47.5 4 32C4 16.5 16.5 4 32 4C47.5 4 60 16.5 60 32C60 47.5 47.5 60 32 60ZM32 10.1C19.9 10.1 10.1 19.9 10.1 32C10.1 44.1 19.9 53.9 32 53.9C44.1 53.9 53.9 44.1 53.9 32C53.9 19.9 44.1 10.1 32 10.1Z" fill="#1e40af"/>
                    <path d="M32 32C32 40.8366 24.8366 48 16 48C7.16344 48 0 40.8366 0 32C0 23.1634 7.16344 16 16 16C24.8366 16 32 23.1634 32 32Z" fill="#3b82f6"/>
                    <path d="M32 32C32 23.1634 39.1634 16 48 16C56.8366 16 64 23.1634 64 32C64 40.8366 56.8366 48 48 48C39.1634 48 32 40.8366 32 32Z" fill="#60a5fa"/>
                </svg>
                <div>
                    <h1 class="text-xl font-extrabold text-slate-800">Civic Companion</h1>
                    <p class="text-sm text-gray-500 font-medium -mt-1">Your AI Medical Assistant</p>
                </div>
            </div>
        </div>
        <!-- AI Disclaimer -->
        <div class="mt-4 w-full p-2 flex items-center justify-center bg-orange-100/50 rounded-xl text-orange-600 border border-orange-200 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-2">
                <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.15 12.42c1.127 1.962-.365 4.377-2.748 4.377H4.999c-2.383 0-3.875-2.415-2.748-4.377L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75z" clip-rule="evenodd" />
            </svg>
            <span class="text-xs font-medium text-center">AI-generated advice is for informational purposes only and is not a substitute for professional medical advice.</span>
        </div>
    </header>

    <div class="container mx-auto flex max-w-7xl space-x-8">
        <!-- Sidebar -->
        <aside class="flex flex-col p-6 rounded-3xl shadow-2xl bg-slate-50 border-2 border-slate-200" style="height: fit-content;">
            <h4 class="text-lg font-semibold text-slate-800 mb-4">Quick Links</h4>
            <div class="flex flex-col space-y-4">
                <button id="find-nearby-help-btn" class="flex items-center justify-start p-4 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:-translate-y-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 6.51-7.5 11.25-7.5 11.25S4.5 17.01 4.5 10.5a7.5 7.5 0 1115 0z" />
                    </svg>
                    <span>Find Help Nearby</span>
                </button>
                <button id="return-to-advice-btn" class="flex items-center justify-start p-4 bg-white text-gray-800 rounded-xl shadow-md hover:bg-gray-100 transition duration-300 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h18" />
                    </svg>
                    <span>Return to Advice</span>
                </button>
                <button id="first-aid-guide-btn" class="flex items-center justify-start p-4 bg-white text-gray-800 rounded-xl shadow-md hover:bg-gray-100 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m-4.5 4.5H18c2.209 0 4-1.791 4-4V6c0-2.209-1.791-4-4-4H6c-2.209 0-4 1.791-4 4v10c0 2.209 1.791 4 4 4z" />
                    </svg>
                    <span>First Aid Guide</span>
                </button>
                <button id="medication-safety-btn" class="flex items-center justify-start p-4 bg-white text-gray-800 rounded-xl shadow-md hover:bg-gray-100 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v-4.5m0 4.5h2.25m-2.25 0V21.75m10.5-4.5H12a2.25 2.25 0 00-2.25 2.25v4.5m-1.5-6.75h-.75V2.25c0-.966.784-1.75 1.75-1.75h14.5c.966 0 1.75.784 1.75 1.75v14.25c0 .966-.784 1.75-1.75 1.75z" />
                    </svg>
                    <span>Medication Safety</span>
                </button>
                <button id="emergency-contacts-btn" class="flex items-center justify-start p-4 bg-white text-gray-800 rounded-xl shadow-md hover:bg-gray-100 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0-1.011 1.79-1.996 4.01-1.996h1.22c.966 0 1.75.784 1.75 1.75v11.5c0 .966-.784 1.75-1.75 1.75h-1.22C4.04 22.25 2.25 21.265 2.25 20.25v-13.5zm19.5 0c0-1.011-1.79-1.996-4.01-1.996h-1.22c-.966 0-1.75.784-1.75 1.75v11.5c0 .966.784 1.75 1.75 1.75h1.22c2.22 0 4.01-1.011 4.01-2.25v-13.5z" />
                    </svg>
                    <span>Emergency Contacts</span>
                </button>
                <button id="mental-health-btn" class="flex items-center justify-start p-4 bg-white text-gray-800 rounded-xl shadow-md hover:bg-gray-100 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 000-18C8.6 3 6.13 5.3 4.5 9c-1.4 3.7-1.12 7.7 0 11.4M12 21c-3.4 0-6.13-2.3-7.5-6s-1.4-7.7 0-11.4" />
                    </svg>
                    <span>Mental Health Resources</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex flex-col space-y-8 flex-1">
            <!-- Top Section: Chat Box - Increased height -->
            <div class="flex flex-col bg-slate-50 rounded-3xl shadow-2xl p-6 relative border-2 border-slate-200 h-[500px]">
                <div class="flex flex-col items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Civic Companion Chat</h2>
                    <p class="text-sm text-gray-500 font-medium mt-1">Ask me anything about your symptoms</p>
                </div>

                <div id="chat-container" class="flex-1 flex flex-col overflow-y-auto p-4 space-y-4 bg-gray-100 rounded-2xl mb-6 shadow-inner">
                    <div class="p-3 my-2 rounded-lg max-w-xs bg-white text-gray-800 self-start shadow rounded-bl-none">
                        Hello! I am an AI Medical Assistant. Please describe your symptoms and I will provide guidance on what to do next.
                    </div>
                </div>

                <div id="loading-indicator" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
                </div>

                <div class="flex space-x-4">
                    <input id="chat-input" type="text" placeholder="Describe your symptoms..." class="flex-1 p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm shadow-md">
                    <button id="send-button" class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Bottom Section: Advice Output - Now takes remaining vertical space -->
            <div class="bg-slate-50 rounded-3xl shadow-2xl p-6 border-2 border-slate-200">
                <div id="advice-output"></div>
            </div>
        </div>
    </div>
</body>
</html>
